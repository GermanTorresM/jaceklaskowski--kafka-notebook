== [[KafkaController]] KafkaController

`KafkaController` is...FIXME

`KafkaController` is <<creating-instance, created>> and immediately <<startup, started>> when `KafkaServer` link:kafka-KafkaServer.adoc#startup[starts up].

.KafkaController
image::images/KafkaController.png[align="center"]

`KafkaController` is the <<isActive, current controller>> of...FIXME when...FIXME

[[logIdent]]
`logIdent` is *[Controller id=[brokerId]]*.

[[internal-registries]]
.KafkaController's Internal Registries and Counters (in alphabetical order)
[cols="1,2",options="header",width="100%"]
|===
| Name
| Description

| [[activeControllerId]] `activeControllerId`
a| The ID of the active `KafkaController`

* Initialized to `-1`

| [[brokerChangeListener]] `brokerChangeListener`
| `BrokerChangeListener` for this `KafkaController` and <<eventManager, eventManager>>

| [[controllerContext]] `controllerContext`
|

| [[eventManager]] `eventManager`
| `ControllerEventManager`

| [[kafkaScheduler]] `kafkaScheduler`
|

| [[partitionStateMachine]] `partitionStateMachine`
|

| [[replicaStateMachine]] `replicaStateMachine`
|

| [[stateChangeLogger]] `stateChangeLogger`
|
|===

=== [[elect]] `elect` Method

[source, scala]
----
elect(): Unit
----

`elect`...FIXME

NOTE: `elect` is used when `KafkaController` enters `Startup` and `Reelect` states.

=== [[onControllerFailover]] `onControllerFailover` Method

CAUTION: FIXME

NOTE: `onControllerFailover` is used exclusively when `KafkaController` is requested to <<elect, elect>>.

=== [[isActive]] `isActive` Method

[source, scala]
----
isActive: Boolean
----

`isActive` says whether the <<activeControllerId, activeControllerId>> equals the broker ID (from <<config, KafkaConfig>>).

CAUTION: FIXME When could they be different?

=== [[startup]] `startup` Method

CAUTION: FIXME

=== [[creating-instance]] Creating KafkaController Instance

`KafkaController` takes the following when created:

* [[config]] link:kafka-KafkaConfig.adoc[KafkaConfig]
* [[zkUtils]] link:kafka-ZkUtils.adoc[ZkUtils]
* [[time]] `Time`
* [[metrics]] `Metrics`
* [[threadNamePrefix]] Optional thread name prefix

`KafkaController` initializes the <<internal-registries, internal registries and counters>>.

=== [[registerBrokerChangeListener]] `registerBrokerChangeListener` Internal Method

[source, scala]
----
registerBrokerChangeListener(): Option[Seq[String]]
----

`registerBrokerChangeListener` requests <<zkUtils, ZkUtils>> to link:kafka-ZkUtils.adoc#subscribeChildChanges[subscribeChildChanges] for `/brokers/ids` path with <<brokerChangeListener, BrokerChangeListener>>.

NOTE: `registerBrokerChangeListener` is used exclusively when `KafkaController` does <<onControllerFailover, onControllerFailover>>.

=== [[getControllerID]] Getting Active Controller ID (from JSON under /controller znode) -- `getControllerID` Method

[source, scala]
----
getControllerID(): Int
----

`getControllerID` returns the ID of the active Kafka controller that is associated with `/controller` znode in JSON format or `-1` otherwise.

Internally, `getControllerID` requests <<zkUtils, ZkUtils>> for link:kafka-ZkUtils.adoc#readDataMaybeNull[data associated with `/controller` znode].

If available, `getControllerID` parses the data (being the current controller info in JSON format) to extract `brokerid` field.

[source, shell]
----
$ ./bin/zookeeper-shell.sh 0.0.0.0:2181
Connecting to 0.0.0.0:2181
Welcome to ZooKeeper!
...
get /controller
{"version":1,"brokerid":100,"timestamp":"1506197069724"}
cZxid = 0xf9
ctime = Sat Sep 23 22:04:29 CEST 2017
mZxid = 0xf9
mtime = Sat Sep 23 22:04:29 CEST 2017
pZxid = 0xf9
cversion = 0
dataVersion = 0
aclVersion = 0
ephemeralOwner = 0x15eaa3a4fdd000d
dataLength = 56
numChildren = 0
----

Otherwise, when no `/controller` znode is available, `getControllerID` returns `-1`.

[NOTE]
====
`getControllerID` is used when:

1. Processing `Reelect` controller event

1. <<elect, elect>>
====
