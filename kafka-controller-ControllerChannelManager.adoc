== [[ControllerChannelManager]] ControllerChannelManager

`ControllerChannelManager` is...FIXME

`ControllerChannelManager` is <<creating-instance, created>> exclusively when `KafkaController` is requested to <<kafka-controller-KafkaController.adoc#startChannelManager, startChannelManager>>.

[[logIdent]]
`ControllerChannelManager` uses *[Channel manager on controller [brokerId]]* as the logging prefix (aka `logIdent`).

=== [[KafkaMetricsGroup]][[metrics]] Performance Metrics

`ControllerChannelManager` is a <<kafka-metrics-KafkaMetricsGroup.adoc#, KafkaMetricsGroup>> with the following performance metrics.

.ControllerChannelManager's Performance Metrics
[cols="30m,70",options="header",width="100%"]
|===
| Metric Name
| Description

| QueueSize
a| [[QueueSize]] Controller requests (`AbstractControlRequests`) queue size (per broker)

| RequestRateAndQueueTimeMs
a| [[RequestRateAndQueueTimeMs]][[requestRateAndQueueTimeMetrics]] For every broker

| TotalQueueSize
a| [[TotalQueueSize]] Total number of controller requests (`AbstractControlRequests`) to be sent out to brokers

|===

The performance metrics are registered in *kafka.controller:type=ControllerChannelManager* group.

.ControllerChannelManager in jconsole
image::images/ControllerChannelManager-jconsole.png[align="center"]

=== [[creating-instance]] Creating ControllerChannelManager Instance

`ControllerChannelManager` takes the following to be created:

* [[controllerContext]] <<kafka-controller-ControllerContext.adoc#, ControllerContext>>
* [[config]] <<kafka-server-KafkaConfig.adoc#, KafkaConfig>>
* [[time]] `Time`
* [[metrics]] <<kafka-Metrics.adoc#, Metrics>>
* [[stateChangeLogger]] `StateChangeLogger`
* [[threadNamePrefix]] Thread name prefix (default: `(empty)`)

`ControllerChannelManager` initializes the <<internal-properties, internal properties>>.

In the end, `ControllerChannelManager` requests the <<controllerContext, ControllerContext>> for the `liveBrokers` that it <<addNewBroker, addNewBroker>> each.

=== [[addNewBroker]] Registering New Broker -- `addNewBroker` Internal Method

[source, scala]
----
addNewBroker(broker: Broker): Unit
----

`addNewBroker`...FIXME

NOTE: `addNewBroker` is used when `ControllerChannelManager` is <<creating-instance, created>> (to connect to live brokers) and is requested to <<addBroker, addBroker>>.

=== [[addBroker]] Registering Newly-Added Broker -- `addBroker` Method

[source, scala]
----
addBroker(broker: Broker): Unit
----

`addBroker`...FIXME

NOTE: `addBroker` is used exclusively when <<kafka-controller-KafkaController.adoc#BrokerChange, BrokerChange>> controller event is processed.

=== [[removeBroker]] Deregistering Broker -- `removeBroker` Method

[source, scala]
----
removeBroker(brokerId: Int): Unit
----

`removeBroker`...FIXME

NOTE: `removeBroker` is used when...FIXME

=== [[startup]] Starting Up -- `startup` Method

[source, scala]
----
startup(): Unit
----

`startup`...FIXME

NOTE: `startup` is used when...FIXME

=== [[shutdown]] Shutting Down -- `shutdown` Method

[source, scala]
----
shutdown(): Unit
----

`shutdown`...FIXME

NOTE: `shutdown` is used when...FIXME

=== [[sendRequest]] Sending AbstractControlRequest Out to Broker -- `sendRequest` Method

[source, scala]
----
sendRequest(
  brokerId: Int,
  request: AbstractControlRequest.Builder[_ <: AbstractControlRequest],
  callback: AbstractResponse => Unit = null)
----

`sendRequest`...FIXME

NOTE: `sendRequest` is used exclusively when `ControllerBrokerRequestBatch` is requested to <<kafka-controller-ControllerBrokerRequestBatch.adoc#sendRequest, send a controller request to a broker>>.

=== [[removeExistingBroker]] `removeExistingBroker` Internal Method

[source, scala]
----
removeExistingBroker(
  brokerState: ControllerBrokerStateInfo): Unit
----

`removeExistingBroker`...FIXME

NOTE: `removeExistingBroker` is used when...FIXME

=== [[startRequestSendThread]] `startRequestSendThread` Internal Method

[source, scala]
----
startRequestSendThread(
  brokerId: Int): Unit
----

`startRequestSendThread`...FIXME

NOTE: `startRequestSendThread` is used when...FIXME

=== [[internal-properties]] Internal Properties

[cols="30m,70",options="header",width="100%"]
|===
| Name
| Description

| brokerStateInfo
a| [[brokerStateInfo]] Broker metadata by broker ID (`HashMap[Int, ControllerBrokerStateInfo]`)

Used when...FIXME

| brokerLock
| [[brokerLock]]

Used when...FIXME
|===
